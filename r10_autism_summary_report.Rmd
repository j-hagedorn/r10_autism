---
title: "Autism Waiver Compliance: Summary Report"
output: 
  html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

```{r}
# Load required packages
library(tidyverse); library(stringr); library(magrittr); library(lubridate); library(readxl)
library(DT); library(forcats); library(plotly); library(sparkline);library(feather)
```

```{r}
# Read in .csv files as dataframes
csv_path <- "C:/Users/joshh/OneDrive - TBD Solutions LLC/files/Region10/Autism/"
svs <- read_feather(paste0(csv_path,"svs.feather"))
# Read in .csv files as dataframes
wsa <- read_feather(paste0(csv_path,"wsa.feather"))
# If re-opened, client is given new 'Case ID' but Medicaid ID (i.e. 'ID') should be same

# Read in data related to authorized units
wsa_ipos <- read_feather(paste0(csv_path,"wsa_ipos.feather"))
```

### This report was generated for Region 10 PIHP on `r max(svs$FROM_DATE)`

*Please note that the data in this report may not reflect the services of all enrollees that participated in the Autism Waiver Program.  Specifically, enrollee services may not show in the data for more recent periods where claims were not yet submitted.*

---

# Eligible Autism Waiver Enrollees without a Plan of Service

As an initial summary, we look at the percent of persons who are enrolled in the autism waiver (i.e. `Status == "Open"`), but who do not have an Individualized Plan of Service (IPOS).

```{r}
wsa_tbl <-
wsa %>%
  filter(Status == "Open") %>%
  group_by(PIHP_CMH_Name) %>%
  summarize(
    without_IPOS = n() - sum(IPOSExists, na.rm = T),
    all = n()
  ) %>%
  mutate(
    pct = round(without_IPOS / all * 100, digits = 1)
  ) 

wsa_tbl %>%
  datatable(
    rownames = FALSE,
    colnames = c('CMHSP','Enrollees without IPOS','All Enrollees','Pct without IPOS'),
    caption = 'Percentage of Autism waiver enrollees without IPOS, by CMHSP',
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(c(0,100), 'grey'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )
  
```

The following analyses will ask different questions for the groups represented here.  

- **Waitlist:** For individuals who do not have an IPOS and are not receiving Autism Waiver services, we will ask whether they receive interim services during their time on the waitlist.  
- **Receiving Services:** For individuals who are receiving autism waiver services, we will ask whether they are receiving services in the amount prescribed in their IPOS and whether their services are being conducted with the appropriate level of observation.

---

# Interim Services for Persons on Autism Waitlist

## Percent of Days Receiving Services per Waitlisted Enrollee

For each individual who is autism waiver eligible and on the waitlist, what percent of the days that the person has been on the waitlist are overlapped by the provision of non-ABA services (i.e. `Days receiving services`/`Days on waitlist`)?

```{r}
waitlist_svs <-
  wsa %>%
  # Filter individuals who are on waitlist
  filter(
    Status == "Open"
    & IPOSExists == F
    & is.na(Eligibility_Date) == F
  ) %>%
  select(ID,Case_ID,PIHP_CMH_Name,Referral_Date:Eligibility_End_Date) %>%
  left_join(svs, by = c("ID" = "MEDICAID_ID")) %>%
  filter(
    # Only include services occurring after eligibility for autism
    # Including a 90-day window for initial scheduling
    FROM_DATE > as.Date(Eligibility_Date) + 90    
    # or if there is no service date (to keep people who didn't receive svs)
    | is.na(FROM_DATE) == T 
  ) %>%
  group_by(Case_ID,PIHP_CMH_Name,CPT_CD,SERVICE_DESC,UNIT_TYPE,AUTISM_SRV,Eligibility_Date) %>%
  # Convert units to a common period
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    svs_conv = recode(
      as.character(SERVICE_DESC),
      `Psychotherapy, 60 min` = 1, 
      `Psychotherapy, 45 min` = 0.75,
      `Psychotherapy, 30 min` = 0.5
    ),
    hr_conv = ifelse(is.na(svs_conv) == F,svs_conv,as.numeric(hr_conv)),
    # Calculate hours
    hrs = UNITS * hr_conv
  ) %>%
  # What is the first and last date of each service?
  mutate(
    first = min(FROM_DATE),
    last = max(FROM_DATE)
  ) %>%
  # What is the number of units received?
  summarize(
    encounters = n(),
    units = sum(UNITS, na.rm = T),
    hrs = sum(hrs, na.rm = T),
    first = min(FROM_DATE),
    last = max(FROM_DATE)
  ) 

```


```{r}
waitlist_person <-
  waitlist_svs %>%
  group_by(Case_ID) %>%
  summarize(
    first = min(first),
    last = max(last),
    Eligibility_Date = as.Date(max(Eligibility_Date)),
    svs_list = paste(SERVICE_DESC, collapse = ', '),
    encounters = sum(encounters),
    autism_waiver_svs = sum(AUTISM_SRV, na.rm = T)
  ) %>%
  mutate(
    # Most recent date in services data pulled
    max_date = max(svs$FROM_DATE),
    elig_interval = as.numeric(max_date - (Eligibility_Date + 90)),
    svs_interval = as.numeric(last - first),
    pct_days_svd = round(svs_interval/elig_interval * 100, digits = 1),
    autism_waiver_svs = autism_waiver_svs > 0
  )

waitlist_person %>%
  plot_ly(
    x = ~pct_days_svd,
    hoverinfo = 'y+text',
    text = ~paste0("# of waitlisted individuals received services<br>",
                   "around this much of the time they were on the waitlist")
  ) %>%
  layout(
    xaxis = list(title = "% of eligible days receiving services"), 
    yaxis = list(title = "# of waitlisted individuals"), 
    showlegend = FALSE
  )

```

# Conformance with Prescribed Hours for ABA Services

What percent of individuals have received ABA services which fall outside of the acceptable range (*i.e. <75% or >125%*) of the prescribed hours?

```{r}

#### Calculate ABA services per week per person ####

# Define ABA codes
aba_cpt <- c("S5108", # Old observation code
             "H2019", # Old treatment codes
             "0364T","0365T","0366T","0367T","0372T","0373T","0374T",
             "0368T","0369T") # Observation codes

aba_rx_hrs <- wsa_ipos %>% select(MEDICAID_ID = Beneficiary_ID,Case_ID,ABA_Hours)

ipos_start <- 
  wsa %>% 
  filter(Status == "Open" & Currently_Inactive == F) %>% 
  select(MEDICAID_ID = ID,IPOS_Start_Date)

last_90 <- as.Date(max(svs$FROM_DATE) - 90)

aba_svs <-
svs %>%
  filter(
    CPT_CD %in% aba_cpt
    & USED_MOD == "U5" # Only include U5 modifier for Autism services
  ) %>%
  droplevels() %>%
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    hr_conv = as.numeric(hr_conv),
    # Calculate hours
    hrs = UNITS * hr_conv,
    # Create week dates for grouping
    week = floor_date(FROM_DATE, unit = "week")
  ) %>%
  select(PROVIDER_NAME,MEDICAID_ID,CPT_CD:FROM_DATE,week,UNITS,hrs) 

aba_summary <-
  aba_svs %>%
  # Get prescribed ABA hours from WSA IPOS
  left_join(aba_rx_hrs, by = "MEDICAID_ID") %>%
  # Get IPOS start date from WSA
  left_join(ipos_start, by = "MEDICAID_ID") %>%
  # Only include services if they occur after the IPOS Start Date
  filter(FROM_DATE >= IPOS_Start_Date) %>%
  # Only include services if they are in most recent 90 days of dataset
  filter(FROM_DATE >= last_90) %>%
  group_by(Case_ID,PROVIDER_NAME,week) %>%
  summarize(
    hrs = sum(hrs, na.rm = T),
    ABA_Hours = max(ABA_Hours)
  ) %>%
  mutate(
    # Calculate difference between actual and prescribed hours
    # Negative values indicate hours less than goal
    diff = hrs - ABA_Hours,
    # Calculate % of prescribed hours received
    # Tag Compliant and Non-Compliant weeks
   
    pct_all = round(sum(hrs) / sum(ABA_Hours) * 100, digits = 1),
    in_range_all = ifelse(between(pct_all,75,125),T,F))%>%
  ungroup() %>%
  group_by(Case_ID,PROVIDER_NAME) %>%
  summarise(
    hrs = sum(hrs, na.rm = T),
    ABA_Hours = sum(ABA_Hours, na.rm = T)
  )%>%
  mutate(
    pct = round(hrs / ABA_Hours * 100, digits = 1),
    in_range = ifelse(between(pct,75,125),T,F))%>%
  group_by(PROVIDER_NAME)%>%
  summarise(
    numerator=sum(in_range),
    denominator=n()
  ) %>%
  mutate(
    pct=round(numerator/denominator*100,digits=1)
  )

aba_summary %>% 
  datatable(
    rownames = FALSE,
    colnames = c('CMHSP','Enrollees within prescribed range','Enrollees receiving ABA Services','Percent meeting standard'),
    caption = 'Percentage of Autism waiver enrollees receiving prescribed ABA hours, by CMHSP for the last 90 days',
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    backgroundSize = '100% 90%',
    background = styleColorBar(c(0,100), 'grey'),
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )

```

# Required Observation of ABA Services

According to the Autism Waiver requirements, for every 10 hours of treatment provided (*including codes from the following:* `0364T`:`0367T`,`0372T`:`0374T`,`H2019`) to an individual client, there should be 1 hour of observation by a licensed practitioner(*including codes from the following:* `S5108`,`0368T`,`0369T`).  The table below shows the percentage of active autism waiver clients at each CMHSP who have received at least the required ratio of treatment to observation (10:1) during the most recent 90 days of available service data.  Individuals with fewer than 10 hours of treatment during this period are omitted from the calculations.  If an individual has not been receiving services for 90 days, the calculation applies to the portion of the interval when they have received services.  The target performance for this measure is that 100% of enrollees receiving ABA services will receive the required observation hours.

```{r}
# Note: uses filters defined above for service codes and clients included

observe <-
svs %>%
  filter(
    CPT_CD %in% aba_cpt
    & USED_MOD == "U5" # Only include U5 modifier for Autism services
  ) %>%
  droplevels() %>%
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    hr_conv = as.numeric(hr_conv),
    # Calculate hours
    hrs = UNITS * hr_conv,
    # Create week dates for grouping
    week = floor_date(FROM_DATE, unit = "week"),
    month = floor_date(FROM_DATE, unit = "month")
  ) %>%
  # Get prescribed ABA hours from WSA IPOS
  left_join(aba_rx_hrs, by = "MEDICAID_ID") %>%
  # Get IPOS start date from WSA
  left_join(ipos_start, by = "MEDICAID_ID") %>%
  # Only include services if they occur after the IPOS Start Date
  filter(week >= IPOS_Start_Date) %>%
  # Only include services if they are in most recent 90 days of dataset
  filter(FROM_DATE >= last_90) %>%
  mutate(
    type = recode(
      CPT_CD,
      `S5108` = "Observation",
      `0368T` = "Observation",
      `0369T` = "Observation",
      `0364T` = "Treatment",
      `0365T` = "Treatment",
      `0366T` = "Treatment",
      `0367T` = "Treatment",
      `0372T` = "Treatment",
      `0373T` = "Treatment",
      `0374T` = "Treatment",
      `H2019` = "Treatment"
    )
  ) %>%
  select(
    Case_ID,PROVIDER_NAME,type,CPT_CD,SERVICE_DESC,
    month,week,FROM_DATE,UNITS,hrs
  ) %>%
  group_by(Case_ID,PROVIDER_NAME,type) %>%
  summarize(hrs = sum(hrs)) %>%
  ungroup() %>%
  mutate(hrs = ifelse(is.na(hrs),0,hrs)) %>%
  spread(type, hrs) %>%
  mutate(
    obs_ratio = round(Observation / Treatment, digits = 2),
    meets_req = obs_ratio >= 0.1 & obs_ratio <= 1.0
  ) %>%
  # Exclude cases with < 10 hours of treatment if they don't meet criteria
  filter(Treatment >= 10 | (Treatment < 10 & meets_req == T))

observe_agg <-
observe %>%
  group_by(PROVIDER_NAME) %>%
  summarize(
    meets_req = sum(meets_req, na.rm = T),
    n = n()
  ) %>%
  mutate(pct = round(meets_req / n * 100, digits = 1)) 
  
observe_agg %>%  
  datatable(
    rownames = FALSE,
    colnames = c('CMHSP','Enrollees with required observation','Enrollees receiving ABA Services','Percent meeting standard'),
    caption = 'Percentage of Autism waiver enrollees receiving required observation, by CMHSP',
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(c(0,100), 'grey'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )

```

