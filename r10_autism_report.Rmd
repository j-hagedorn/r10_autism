---
title: "Autism Service Compliance"
output:
  html_document:
    code_folding: hide
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warning=FALSE)
```

**Please note that this is currently a draft report under development with analysts at Region 10 PIHP**

```{r}
# Install packages if you need them
# if (!require("tidyverse")) install.packages("tidyverse")
# if (!require("stringr")) install.packages("stringr")
# if (!require("magrittr")) install.packages("magrittr")
# if (!require("lubridate")) install.packages("lubridate")
# if (!require("plotly")) install.packages("plotly")
# if (!require("readxl")) install.packages("readxl")

# Load required packages
library(tidyverse); library(stringr); library(magrittr); library(lubridate); library(readxl)
library(DT); library(forcats); library(plotly); library(sparkline);library(feather)
library(data.table); library(reshape2); library(dplyr)
```

# Reading in Data


First, we read in the services data and process it for analysis.  Note that we are currently reading from .csv file output for this draft analysis.  A repeatable, automated process will rely on connection to database tables updated via an extract-transfer-load (ETL) process.  We also read in the waiver enrollment data from WSA.

```{r}
# Read in .csv files as dataframes
svs <- read_feather("data/svs.feather")
svs$MEDICAID_ID <- as.character(svs$MEDICAID_ID)
# Read in .csv files as dataframes
wsa <- read_feather("data/wsa.feather")
wsa$ID <- as.character(wsa$ID)
# If re-opened, client is given new 'Case ID' but Medicaid ID (i.e. 'ID') should be same

# Read in data related to authorized units
wsa_ipos <- read_feather("data/wsa_ipos.feather")

```

### This report was generated for Region 10 PIHP on `r max(svs$FROM_DATE)`

*Please note that the data in this report may not reflect the services of all enrollees that participated in the Autism Waiver Program.  Specifically, enrollee services may not show in the data for more recent periods where claims were not yet submitted.*

---

# Enrollees without a Behavioral Plan of Service

As an initial summary, we look at the percent of enrollees, but who do not have a Behavioral Plan of Service (BPOS).

*Percentage of enrollees without BPOS, by CMHSP*


```{r}
wsa_tbl <-
wsa %>%
  filter(Status == "Open") %>%
  group_by(PIHP_CMH_Name) %>%
  summarize(
    without_IPOS = n() - sum(IPOSExists, na.rm = T),
    all = n()
  ) %>%
  mutate(
    pct = round(without_IPOS / all * 100, digits = 1)
  ) 

wsa_tbl %>%
  datatable(
    rownames = FALSE,
    colnames = c('CMHSP','Waitlised Enrollees','Enrollees','Pct of waitlisted Enrollees'),
    caption = 'Percentage of Autism waiver enrollees without BPOS, by CMHSP',
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(data = c(0,100), color = 'grey'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )
  
```


# Non-ABA Service for Waitlisted Enrollees

For each waitlisted enrollee, what non-ABA services are he/she receiving while they are waiting? At what frequency?  The table below shows a summary of services received by each enrollee in the waiver who has been placed on the waitlist.^[]  It includes the following information:


```{r}

waitlist_svs <-
  wsa %>%
  # Filter individuals who are on waitlist
  filter(
    Status == "Open"
    & IPOSExists == F
    & is.na(Eligibility_Date) == F
  ) %>%
  select(ID,Case_ID,PIHP_CMH_Name,Referral_Date:Eligibility_End_Date) %>%
  left_join(svs, by = c("ID" = "MEDICAID_ID")) %>%
  filter(
    # Only include services occurring after eligibility for autism
    # Including a 90-day window for initial scheduling
    FROM_DATE > as.Date(Eligibility_Date) + 90
    # or if there is no service date (to keep people who didn't receive svs)
    | is.na(FROM_DATE) == T 
  ) %>%
  group_by(Case_ID,PIHP_CMH_Name,CPT_CD,SERVICE_DESC,UNIT_TYPE,AUTISM_SRV,Eligibility_Date) %>%
  # Convert units to a common period
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    svs_conv = recode(
      as.character(SERVICE_DESC),
      `Psychotherapy, 60 min` = 1, 
      `Psychotherapy, 45 min` = 0.75,
      `Psychotherapy, 30 min` = 0.5
    ),
    hr_conv = ifelse(is.na(svs_conv) == F,svs_conv,as.numeric(hr_conv)),
    # Calculate hours
    hrs = UNITS * hr_conv
  ) %>%
  # What is the first and last date of each service?
  mutate(
    first = min(FROM_DATE),
    last = max(FROM_DATE)
  ) %>%
  # What is the number of units received?
  summarize(
    encounters = n(),
    units = sum(UNITS, na.rm = T),
    hrs = sum(hrs, na.rm = T),
    first = min(FROM_DATE),
    last = max(FROM_DATE)
  ) 

waitlist_person <-
  waitlist_svs %>%
  group_by(Case_ID) %>%
  summarize(
    first = min(first),
    last = max(last),
    Eligibility_Date = as.Date(max(Eligibility_Date)),
    svs_list = paste(SERVICE_DESC, collapse = ', '),
    encounters = sum(encounters),
    autism_waiver_svs = sum(AUTISM_SRV, na.rm = T)
  ) %>%
  mutate(
    # Most recent date in services data pulled
    max_date = max(svs$FROM_DATE),
    elig_interval = as.numeric(max_date - (Eligibility_Date + 90)),
    svs_interval = as.numeric(last - first),
    pct_days_svd = round(svs_interval/elig_interval * 100, digits = 1),
    autism_waiver_svs = autism_waiver_svs > 0
  )

t1 <- waitlist_person %>%
  select(Case_ID,svs_list,elig_interval,svs_interval,pct_days_svd,encounters,autism_waiver_svs) %>%
  ungroup() %>%
  arrange(pct_days_svd)

t2 <- wsa %>%
  # Filter individuals who are on waitlist
  filter(
    Status == "Open"
    & IPOSExists == F
    & is.na(Eligibility_Date) == F
  ) %>%
  select(ID,Case_ID,PIHP_CMH_Name,Referral_Date:Eligibility_End_Date) %>%
  left_join(svs, by = c("ID" = "MEDICAID_ID")) %>%
  filter(
    # Only include services occurring after eligibility for autism
    FROM_DATE >= as.Date(Eligibility_Date) 
    # or if there is no service date (to keep people who didn't receive svs)
    | is.na(FROM_DATE) == T 
  ) %>%
  mutate(
    week = floor_date(FROM_DATE, unit = "week"),
    month = floor_date(FROM_DATE, unit = "month")
  ) %>%
  group_by(Case_ID,month) %>%
  summarize(Encounters = n()) %>%
  ungroup() %>%
  group_by(Case_ID) %>%
  summarise(
    Encounters = paste(Encounters, collapse = ","))

r <- range(t2$Encounters) # define min/max # of encounters for sparkline

t3 <- merge(x = t2, y = t1, by = "Case_ID", all.x = TRUE) # join t1 ad t2


# Define attributes of line spark
line_string <- "type: 'line', lineColor: 'black', fillColor: '#ccc', highlightLineColor: 'orange', highlightSpotColor: 'orange'"

cd <- list(list(targets = 1, render = JS("function(data, type, full){ return '<span class=sparkSeries>' + data + '</span>' }")))

cb = JS(paste0("function (oSettings, json) {
               \n  $('.sparkSeries:not(:has(canvas))').sparkline('html', { ", line_string, " });
               \n}")
        , collapse = "")

dt <- t3 %>%
  datatable(
    data.table(),
    rownames = FALSE,
    colnames = c('WSA ID','Consistency of Encounters',
                 'Services provided',
                 'Days on waitlist','Days receiving services','Percent days covered',
                 'Total Number of encounters','Contains waiver services'),
    extensions = c('Responsive','Buttons'),
    options = list(
      columnDefs = cd,
      pageLength = 5,
      lengthMenu = c(5, 15, 25, 50),
      fnDrawCallback = cb,
      # dom = 't',
      buttons = c('colvis'))
    )

dt$dependencies <- append(dt$dependencies, htmlwidgets:::getDependency("sparkline"))
dt

```

# Range of Intensity Compliance

Hours of treatment provided within 25% +/- of authorized hours. 

```{r}

#### Calculate ABA services per week per person ####

# Define ABA codes
aba_cpt <- c("S5108", # Old observation code
             "H2019", # Old treatment codes
             "0364T","0365T","0366T","0367T","0372T","0373T","0374T",
             "0368T","0369T") # Observation codes

aba_rx_hrs <- wsa_ipos %>% select(MEDICAID_ID = Beneficiary_ID,Case_ID,ABA_Hours)

ipos_start <- 
  wsa %>% 
  filter(Status == "Open" & Currently_Inactive == F) %>% 
  select(MEDICAID_ID = ID,IPOS_Start_Date)

last_90 <- as.Date(max(svs$FROM_DATE) - 90)

aba_svs <-
svs %>%
  filter(
    CPT_CD %in% aba_cpt
    & USED_MOD == "U5" # Only include U5 modifier for Autism services
  ) %>%
  # Now remove observation codes
  filter(!CPT_CD %in% c("S5108","0368T","0369T")) %>%
  droplevels() %>%
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    hr_conv = as.numeric(hr_conv),
    # Calculate hours
    hrs = UNITS * hr_conv,
    # Create week dates for grouping
    week = floor_date(FROM_DATE, unit = "week")
  ) %>%
  select(PROVIDER_NAME,MEDICAID_ID,CPT_CD:FROM_DATE,week,UNITS,hrs) 

aba_week <-
  aba_svs %>%
  # Get prescribed ABA hours from WSA IPOS
  left_join(aba_rx_hrs, by = "MEDICAID_ID") %>%
  # Get IPOS start date from WSA
  left_join(ipos_start, by = "MEDICAID_ID") %>%
  # Only include services if they occur after the IPOS Start Date
  filter(FROM_DATE >= as.Date(IPOS_Start_Date)) %>%
  # Only include services if they are in most recent 90 days of dataset
  filter(FROM_DATE >= last_90) %>%
  mutate(
    type = recode(
      CPT_CD,
      `S5108` = "Observation",
      `0368T` = "Observation",
      `0369T` = "Observation",
      `0364T` = "Treatment",
      `0365T` = "Treatment",
      `0366T` = "Treatment",
      `0367T` = "Treatment",
      `0372T` = "Treatment",
      `0373T` = "Treatment",
      `0374T` = "Treatment",
      `H2019` = "Treatment"
    )
  ) %>%
  group_by(Case_ID,week,type) %>%
  summarize(
    hrs = sum(hrs, na.rm = T),
    ABA_Hours = max(ABA_Hours, na.rm = T)
  ) %>%
  ungroup() %>%
  spread(type,hrs) %>%
  mutate(
    # Recombine for total count
    hrs = Treatment + Observation,
    # Calculate difference between actual and prescribed hours
    # Negative values indicate hours less than goal
    diff = hrs - ABA_Hours,
    # Calculate % of prescribed hours received
    pct = round(hrs / ABA_Hours * 100, digits = 1),
    # Tag Compliant and Non-Compliant weeks
    in_range_wk = ifelse(between(pct,75,125),T,F)
  ) %>%
  ungroup() %>%
  group_by(Case_ID) %>%
  mutate(
    pct_all = round(sum(hrs) / sum(ABA_Hours) * 100, digits = 1),
    in_range_all = ifelse(between(pct_all,75,125),T,F)
  ) 

aba_per <-
  aba_week %>%
  group_by(Case_ID) %>%
  summarize(
    hrs = sum(hrs, na.rm = T),
    rx_hrs = sum(ABA_Hours, na.rm = T)
  ) %>%
  mutate(
    pct = round(hrs / rx_hrs * 100, digits = 1),
    in_range = ifelse(between(pct,75,125),T,F)
  )

aba_per %>%
  mutate(
    Case_ID = fct_reorder(Case_ID,desc(pct)),
    in_range = ifelse(in_range == T,"Within range","Out of range")
  ) %>%
  plot_ly(x = ~Case_ID, y = ~pct, color = ~in_range, colors = c("#b0145b","#088da5")) %>%
  layout(
    title = "Range of Intensity Compliance",
    xaxis = list(title = "Autism Waiver Enrollee",zeroline = F,showline = F,showticklabels = F,showgrid = F), 
    yaxis = list(title = "Hours of treatment")
  )


```



```{r}
aba_per %>% 
  filter(in_range == F) %>% 
  select(-in_range) %>%
  arrange(desc(pct)) %>%
  datatable(
    rownames = FALSE,
    colnames = c('WSA ID','Hours of service','Prescribed Hours','Percent of prescribed hrs'),
    caption = 'Enrollees with non-compliance in hours of treatment.'
  )
```


# Observation Compliance



```{r}
# Note: uses filters defined above for service codes and clients included

observe <-
svs %>%
  filter(
    CPT_CD %in% aba_cpt
    & USED_MOD == "U5" # Only include U5 modifier for Autism services
  ) %>%
  droplevels() %>%
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    hr_conv = as.numeric(hr_conv),
    # Calculate hours
    hrs = UNITS * hr_conv,
    # Create week dates for grouping
    week = floor_date(FROM_DATE, unit = "week"),
    month = floor_date(FROM_DATE, unit = "month")
  ) %>%
  # Get prescribed ABA hours from WSA IPOS
  left_join(aba_rx_hrs, by = "MEDICAID_ID") %>%
  # Get IPOS start date from WSA
  left_join(ipos_start, by = "MEDICAID_ID") %>%
  # Only include services if they occur after the IPOS Start Date
  filter(week >= IPOS_Start_Date) %>%
  # Only include services if they are in most recent 90 days of dataset
  filter(FROM_DATE >= last_90) %>%
  mutate(
    type = recode(
      CPT_CD,
      `S5108` = "Observation",
      `0368T` = "Observation",
      `0369T` = "Observation",
      `0364T` = "Treatment",
      `0365T` = "Treatment",
      `0366T` = "Treatment",
      `0367T` = "Treatment",
      `0372T` = "Treatment",
      `0373T` = "Treatment",
      `0374T` = "Treatment",
      `H2019` = "Treatment"
    )
  ) %>%
  select(
    Case_ID,PROVIDER_NAME,type,CPT_CD,SERVICE_DESC,
    month,week,FROM_DATE,UNITS,hrs
  ) %>%
  group_by(Case_ID,PROVIDER_NAME,type) %>%
  summarize(hrs = sum(hrs)) %>%
  ungroup() %>%
  mutate(hrs = ifelse(is.na(hrs),0,hrs)) %>%
  spread(type, hrs) %>%
  mutate(
    obs_ratio = round(Observation / Treatment, digits = 2),
    meets_req = obs_ratio >= 0.1 & obs_ratio <= 1.0
  ) %>%
  # Exclude cases with < 10 hours of treatment if they don't meet criteria
  filter(Treatment >= 10 | (Treatment < 10 & meets_req == T))

observe_agg <-
observe %>%
  group_by(PROVIDER_NAME) %>%
  summarize(
    meets_req = sum(meets_req, na.rm = T),
    n = n()
  ) %>%
  mutate(pct = round(meets_req / n * 100, digits = 1)) 
  
observe_agg %>%  
  datatable(
    rownames = FALSE,
    colnames = c('CMHSP','Enrollees with required observation','Enrollees','Percent meeting standard'),
    caption = 'Percentage of enrollees receiving required observation, by CMHSP',
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(data = c(0,100), color = 'grey'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )

```

For a detailed view of the individuals who have not received the appropriate level of observation for ABA services, please see the table below:

```{r}


observe %>%
  filter(meets_req == F) %>%
  select(-meets_req) %>%
  arrange(desc(obs_ratio)) %>%
  datatable(
    rownames = FALSE,
    colnames = c('WSA ID','CMHSP','Hours of treatment','Hours of observation','Ratio of observation to treatment'),
    caption = 'Individuals without required observation for ABA treatment',
    extensions = c('Responsive','Buttons'),
    options = list(
      pageLength = 10,
      lengthMenu = c(10, 25, 50),
      buttons = c('colvis')
    )
  )

```


