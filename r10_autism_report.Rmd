---
title: "Autism Benefit Compliance"
output:
  html_document:
    code_folding: hide
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load_libs}
# Load required packages
library(tidyverse); library(stringr); library(magrittr); library(lubridate); library(readxl)
library(DT); library(forcats); library(plotly); library(sparkline);library(feather)
library(data.table); library(reshape2); library(dplyr)
```

```{r read_data}
# Read in .csv files as dataframes
svs <- read_feather("data/svs.feather")
svs$MEDICAID_ID <- as.character(svs$MEDICAID_ID)
# Read in .csv files as dataframes
wsa <- read_feather("data/wsa.feather")
wsa$ID <- as.character(wsa$ID)
# If re-opened, client is given new 'Case ID' but Medicaid ID (i.e. 'ID') should be same

# Read in data related to authorized units
wsa_ipos <- read_feather("data/wsa_ipos.feather")

```

<h4>This *full detail* report was generated for Region 10 PIHP on `r Sys.Date()` using data from `r min(svs$FROM_DATE, na.rm = T)` - `r max(svs$FROM_DATE, na.rm = T)`</h4>

*Please note that the data in this report may not reflect all services that enrollees received from the Autism Benefit.  Specifically, services may not appear for more recent periods if claims have not yet been submitted.*

---

# Overdue Re-Evaluations

```{r reeval_create}
reeval_tbl <-
wsa %>%
  filter(Status == "Open") %>%
  mutate(
    past_due = ReEvaluation_Due_Date < today()
  ) %>%
  group_by(PIHP_CMH_Name) %>%
  summarize(
    numerator = sum(past_due, na.rm = T),
    denominator = n()
  ) %>%
  mutate(
    pct = round(numerator / denominator * 100, digits = 1)
  ) %>%
  arrange(as.character(PIHP_CMH_Name)) %>%
  # Add subtotal line for PIHP
  rbind(
    ., 
    data.frame(
      PIHP_CMH_Name = "Region 10", 
      t(colSums(.[2:3])),
      pct = round(colSums(.[2])/colSums(.[3])*100,digits = 1)
    )
  ) %>%
  select(PIHP_CMH_Name,denominator,numerator,pct)
```

```{r reeval_table}
reeval_tbl %>%
  datatable(
    rownames = FALSE,
    colnames = c('Organization','Total Enrollees','Overdue Re-Evaluations','% of Enrollees Overdue'),
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(c(0,100), '#fc8d59'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )
```
<br>

The table below shows all open individuals with an overdue re-evaluation:

```{r reeval_detail}
wsa %>%
  filter(Status == "Open") %>%
  mutate(
    past_due = ReEvaluation_Due_Date < today()
  ) %>%
  filter(past_due == T) %>%
  select(Case_ID,PIHP_CMH_Name,ReEvaluation_Due_Date) %>%
  mutate(
    ReEvaluation_Due_Date = ymd(ReEvaluation_Due_Date),
    days_overdue = as.numeric(today() - as.Date(ReEvaluation_Due_Date))
  ) %>%
  datatable(
    rownames = FALSE,
    colnames = c('WSA ID','Organization','Re-Evaluation Date','Days Overdue'),
    options = list(
      pageLength = 5,
      lengthMenu = c(5, 15, 25, 50, nrow(wsa))
    )
  )
```

---

# Overdue Plans of Service

```{r bpos_create}
bpos_tbl <-
wsa %>%
  filter(
    Status == "Open" 
    & Currently_Inactive == F
    & IPOSExists == T) %>%
  mutate(
    past_due = IPOS_Due_Date < today()
  ) %>%
  group_by(PIHP_CMH_Name) %>%
  summarize(
    numerator = sum(past_due, na.rm = T),
    denominator = n_distinct(Case_ID)
  ) %>%
  mutate(
    pct = round(numerator / denominator * 100, digits = 1)
  ) %>%
  arrange(as.character(PIHP_CMH_Name)) %>%
  # Add subtotal line for PIHP
  rbind(
    ., 
    data.frame(
      PIHP_CMH_Name = "Region 10", 
      t(colSums(.[2:3])),
      pct = round(colSums(.[2])/colSums(.[3])*100,digits = 1)
    )
  ) %>%
  select(PIHP_CMH_Name,denominator,numerator,pct)
```

```{r bpos_table}
bpos_tbl %>%
  datatable(
    rownames = FALSE,
    colnames = c('Organization','Total Enrollees with BPOS','Overdue BPOS','% of Enrollees Overdue'),
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(c(0,100), '#fc8d59'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )
```
<br>

The table below shows all open individuals with an overdue plan of service:

```{r bpos_detail}

wsa %>%
  filter(Status == "Open" & IPOSExists == T) %>%
  mutate(
    past_due = IPOS_Due_Date < today()
  ) %>%
  filter(past_due == T) %>%
  select(Case_ID,PIHP_CMH_Name,IPOS_Due_Date) %>%
  mutate(
    IPOS_Due_Date = ymd(IPOS_Due_Date),
    days_overdue = as.numeric(today() - as.Date(IPOS_Due_Date))
  ) %>%
  datatable(
    rownames = FALSE,
    colnames = c('WSA ID','Organization','BPOS Due Date','Days Overdue'),
    options = list(
      pageLength = 5,
      lengthMenu = c(5, 15, 25, 50, nrow(wsa))
    )
  )

```

---

# Enrollees Without Behavioral Plan of Service

Enrollees approved for ABA and are awaiting the development of an ABA behavior treatment plan to begin services.

```{r start_create}
wsa_tbl <-
wsa %>%
  filter(Status == "Open") %>%
  group_by(PIHP_CMH_Name) %>%
  summarize(
    numerator = n() - sum(IPOSExists, na.rm = T),
    denominator = n()
  ) %>%
  mutate(
    pct = round(numerator / denominator * 100, digits = 1)
  ) %>%
  arrange(as.character(PIHP_CMH_Name)) %>%
  # Add subtotal line for PIHP
  rbind(
    ., 
    data.frame(
      PIHP_CMH_Name = "Region 10", 
      t(colSums(.[2:3])),
      pct = round(colSums(.[2])/colSums(.[3])*100,digits = 1)
    )
  ) %>%
  select(PIHP_CMH_Name,denominator,numerator,pct)
```

```{r start_table}
wsa_tbl %>%
  datatable(
    rownames = FALSE,
    colnames = c('Organization','Total Enrollees','Total Enrollees without a BPOS','% of Enrollees without BPOS'),
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(c(0,100), '#fc8d59'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )
```
<br>

The table below shows all open individuals without a Behavioral Plan of Service:

```{r start_detail}
wsa %>%
  filter(Status == "Open") %>%
  filter(IPOSExists == F) %>%
  select(Case_ID,PIHP_CMH_Name,Eligibility_Date) %>%
  mutate(
    Eligibility_Date = ymd(Eligibility_Date),
    days_wo_bpos = as.numeric(today() - as.Date(Eligibility_Date))
  ) %>%
  filter(days_wo_bpos > 0) %>%
  datatable(
    rownames = FALSE,
    colnames = c('WSA ID','Organization','Eligibility Date','Days without BPOS'),
    options = list(
      pageLength = 5,
      lengthMenu = c(5, 15, 25, 50, nrow(wsa))
    )
  )
```

---

# Range of Intensity Non-Compliance

```{r roi_create}

#### Calculate ABA services per week per person 

# Define ABA codes
aba_cpt <- c("S5108", # Old observation code
             "H2019", # Old treatment codes
             "0364T","0365T","0366T","0367T","0372T","0373T","0374T",
             "0368T","0369T") # Observation codes

aba_rx_hrs <- wsa_ipos %>% select(MEDICAID_ID = Beneficiary_ID,Case_ID,ABA_Hours)

ipos_start <- 
  wsa %>% 
  filter(Status == "Open") %>%
  filter(Currently_Inactive == F) %>%
  select(MEDICAID_ID = ID,IPOS_Start_Date)

last_90 <- as.Date(max(svs$FROM_DATE, na.rm = T) - 90)

aba_svs <-
svs %>%
  filter(
    CPT_CD %in% aba_cpt
    & USED_MOD == "U5" # Only include U5 modifier for Autism services
  ) %>%
  # Now remove observation codes
  filter(!CPT_CD %in% c("S5108","0368T","0369T")) %>%
  # Only include services if they are in most recent 90 days of dataset
  filter(
    FROM_DATE >= last_90
    | is.na(FROM_DATE) == T
  ) %>%
  droplevels() %>%
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    hr_conv = as.numeric(hr_conv),
    # Calculate hours
    hrs = UNITS * hr_conv,
    # Create week dates for grouping
    week = floor_date(FROM_DATE, unit = "week")
  ) %>%
  select(PROVIDER_NAME,MEDICAID_ID,CPT_CD:FROM_DATE,week,UNITS,hrs) 

aba_summary <-
  # Start with WSA
  wsa %>%
  filter(Status == "Open") %>%
  filter(Currently_Inactive == F) %>%
  filter(IPOSExists == T) %>%
  select(
    MEDICAID_ID = ID,
    PIHP_CMH_Name,
    Case_ID
  ) %>%
  # Join with IPOS start date from WSA
  left_join(ipos_start, by = "MEDICAID_ID") %>%
  # Join to ABA services
  left_join(aba_svs, by = "MEDICAID_ID") %>%
  # Get prescribed ABA hours from WSA IPOS
  left_join(aba_rx_hrs, by = "MEDICAID_ID") %>%
  # Remove Case IDs which are duplicated in IPOS dataset
  rename(Case_ID = Case_ID.x) %>%
  select(-Case_ID.y) %>%
  # Only include services if they occur after the IPOS Start Date
  filter(
    FROM_DATE >= IPOS_Start_Date
    | is.na(FROM_DATE) == T
  ) %>%
  group_by(Case_ID,PIHP_CMH_Name,week) %>%
  summarize(
    hrs = sum(hrs, na.rm = T),
    ABA_Hours = max(ABA_Hours)
  ) %>%
  mutate(
    # Calculate difference between actual and prescribed hours
    # Negative values indicate hours less than goal
    diff = hrs - ABA_Hours,
    # Calculate % of prescribed hours received
    pct_all = round(sum(hrs) / sum(ABA_Hours) * 100, digits = 1),
    # Tag Compliant and Non-Compliant weeks
    in_range_all = ifelse(between(pct_all,75,125),T,F)
  ) %>%
  ungroup() %>%
  group_by(Case_ID,PIHP_CMH_Name) %>%
  summarize(
    hrs = sum(hrs, na.rm = T),
    ABA_Hours = sum(ABA_Hours, na.rm = T)
  ) %>%
  mutate(
    pct = round(hrs / ABA_Hours * 100, digits = 1),
    in_range = ifelse(between(pct,75,125),T,F)
  ) %>%
  group_by(PIHP_CMH_Name) %>%
  summarize(
    in_range =  sum(in_range),
    denominator = n_distinct(Case_ID)
  ) %>%
  mutate(
    numerator = denominator - in_range,
    pct = round(numerator/denominator * 100, digits = 1)
  ) %>% 
  select(PIHP_CMH_Name,numerator,denominator,pct) %>%
  arrange(as.character(PIHP_CMH_Name)) %>%
  # Add subtotal line for PIHP
  rbind(
    ., 
    data.frame(
      PIHP_CMH_Name = "Region 10", 
      t(colSums(.[2:3])),
      pct = round(colSums(.[2])/colSums(.[3])*100,digits = 1)
    )
  ) %>%
  select(PIHP_CMH_Name,denominator,numerator,pct)

aba_week <-
  aba_svs %>%
  # Get prescribed ABA hours from WSA IPOS
  left_join(aba_rx_hrs, by = "MEDICAID_ID") %>%
  # Get IPOS start date from WSA
  left_join(ipos_start, by = "MEDICAID_ID") %>%
  # Only include services if they occur after the IPOS Start Date
  filter(FROM_DATE >= as.Date(IPOS_Start_Date)) %>%
  # Only include services if they are in most recent 90 days of dataset
  filter(FROM_DATE >= last_90) %>%
  group_by(Case_ID,PROVIDER_NAME,week) %>%
  summarize(
    hrs = sum(hrs, na.rm = T),
    ABA_Hours = max(ABA_Hours, na.rm = T)
  ) %>%
  ungroup() %>%
  mutate(
    # Calculate difference between actual and prescribed hours
    # Negative values indicate hours less than goal
    diff = hrs - ABA_Hours,
    # Calculate % of prescribed hours received
    pct = round(hrs / ABA_Hours * 100, digits = 1),
    # Tag Compliant and Non-Compliant weeks
    in_range_wk = ifelse(between(pct,75,125),T,F)
  ) %>%
  ungroup() %>%
  group_by(Case_ID,PROVIDER_NAME) %>%
  mutate(
    pct_all = round(sum(hrs) / sum(ABA_Hours) * 100, digits = 1),
    in_range_all = ifelse(between(pct_all,75,125),T,F)
  ) 

aba_per <-
  aba_week %>%
  group_by(Case_ID,PROVIDER_NAME) %>%
  summarize(
    hrs = sum(hrs, na.rm = T),
    rx_hrs = sum(ABA_Hours, na.rm = T)
  ) %>%
  mutate(
    pct = round(hrs / rx_hrs * 100, digits = 1),
    in_range = ifelse(between(pct,75,125),T,F)
  )

```

```{r roi_table}
aba_summary %>%
  datatable(
    rownames = FALSE,
    colnames = c('Organization','Total Enrollees with a Behavioral Plan of Service','Enrollees Non-Compliant','% Non-Compliant'),
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    backgroundSize = '100% 90%',
    background = styleColorBar(c(0,100), '#fc8d59'),
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )
```
<br>
```{r roi_detail}
aba_per %>% 
  filter(in_range == F) %>% 
  select(-in_range) %>%
  arrange(desc(pct)) %>%
  datatable(
    rownames = FALSE,
    colnames = c('WSA ID','Organization','Hours of Treatment','Prescribed Hours','% of Prescribed Hours'),
    options = list(
      pageLength = 5,
      lengthMenu = c(5, 15, 25, 50, nrow(aba_per))
    )
  )
```

---

# Observation Non-Compliance

```{r observe_create}
# Note: uses filters defined above for service codes and clients included

observe <-
svs %>%
  filter(
    CPT_CD %in% aba_cpt
    & USED_MOD == "U5" # Only include U5 modifier for Autism services
  ) %>%
  droplevels() %>%
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    hr_conv = as.numeric(hr_conv),
    # Calculate hours
    hrs = UNITS * hr_conv,
    # Create week dates for grouping
    week = floor_date(FROM_DATE, unit = "week"),
    month = floor_date(FROM_DATE, unit = "month")
  ) %>%
  # Get prescribed ABA hours from WSA IPOS
  left_join(aba_rx_hrs, by = "MEDICAID_ID") %>%
  # Get IPOS start date from WSA
  left_join(ipos_start, by = "MEDICAID_ID") %>%
  # Only include services if they occur after the IPOS Start Date
  filter(week >= IPOS_Start_Date) %>%
  # Only include services if they are in most recent 90 days of dataset
  filter(FROM_DATE >= last_90) %>%
  mutate(
    type = recode(
      CPT_CD,
      `S5108` = "Observation",
      `0368T` = "Observation",
      `0369T` = "Observation",
      `0364T` = "Treatment",
      `0365T` = "Treatment",
      `0366T` = "Treatment",
      `0367T` = "Treatment",
      `0372T` = "Treatment",
      `0373T` = "Treatment",
      `0374T` = "Treatment",
      `H2019` = "Treatment"
    )
  ) %>%
  select(
    Case_ID,PROVIDER_NAME,type,CPT_CD,SERVICE_DESC,
    month,week,FROM_DATE,UNITS,hrs
  ) %>%
  group_by(Case_ID,PROVIDER_NAME,type) %>%
  summarize(hrs = sum(hrs)) %>%
  ungroup() %>%
  mutate(hrs = ifelse(is.na(hrs),0,hrs)) %>%
  spread(type, hrs) %>%
  mutate(
    obs_ratio = round(Observation / Treatment, digits = 2),
    meets_req = obs_ratio >= 0.1 & obs_ratio <= 1.0
  ) %>%
  # Exclude cases with < 10 hours of treatment if they don't meet criteria
  filter(Treatment >= 10 | (Treatment < 10 & meets_req == T))

observe_agg <-
observe %>%
  group_by(PROVIDER_NAME) %>%
  summarize(
    meets_req = sum(meets_req, na.rm = T),
    denominator = n()
  ) %>%
  mutate(
    numerator = denominator - meets_req,
    pct = round(numerator / denominator * 100, digits = 1)
  ) %>% 
  select(PROVIDER_NAME,numerator,denominator,pct) %>%
  arrange(as.character(PROVIDER_NAME)) %>%
  # Add subtotal line for PIHP
  rbind(
    ., 
    data.frame(
      PROVIDER_NAME = "Region 10", 
      t(colSums(.[2:3])),
      pct = round(colSums(.[2])/colSums(.[3])*100,digits = 1)
    )
  ) %>%
  select(PROVIDER_NAME,denominator,numerator,pct)

```

```{r observe_table}
observe_agg %>%
  datatable(
    rownames = FALSE,
    colnames = c('Organization','Enrollees with 10+ Hrs of ABA Svs','Enrollees Non-Compliant','% Non-Compliant'),
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(c(0,100), '#fc8d59'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )
```
<br>
```{r observe_detail}

observe %>%
  filter(meets_req == F) %>%
  select(-meets_req) %>%
  arrange(desc(obs_ratio)) %>%
  datatable(
    rownames = FALSE,
    colnames = c('WSA ID','Organization','Hours of Treatment','Hours of Observation','Ratio of Observation to Treatment'),
    caption = 'Individuals without required observation for ABA treatment',
    extensions = c('Responsive','Buttons'),
    options = list(
      pageLength = 10,
      lengthMenu = c(10, 25, 50, nrow(observe)),
      buttons = c('colvis')
    )
  )

```

---

# Family Training Non-Compliance

The table below shows the number of individuals who received autism benefit services during the last 90 days, and the number of those individuals who received family training services during that time.

```{r family_create}

# Required service provided by qualified practitioner. At least 1 encounter / 90 days meets the standard.  The service codes for Family Training are 0370T and 0371T.

family_svs <-
svs %>%
  filter(
    USED_MOD == "U5" # Only include U5 modifier for Autism services
    & FROM_DATE >= last_90
  ) %>%
  # Get prescribed ABA hours from WSA IPOS
  left_join(wsa_ipos, by = c("MEDICAID_ID" = "Beneficiary_ID")) %>%
  mutate(
    # Define family training codes
    family_svc = CPT_CD %in% c("0370T","0371T")
  ) %>%
  select(Case_ID,PROVIDER_NAME,CPT_CD,FROM_DATE,family_svc) %>%
  group_by(Case_ID,PROVIDER_NAME) %>%
  summarize(fam_svs = sum(family_svc, na.rm = T)) %>%
  mutate(has_fam = fam_svs > 0)

family_summary <-
family_svs %>%
  group_by(PROVIDER_NAME) %>%
  summarize(
    denominator = n_distinct(Case_ID),
    has_fam = sum(has_fam, na.rm = T)
  ) %>%
  mutate(
    numerator = denominator - has_fam,
    pct = round(numerator / denominator * 100, digits = 1)
  ) %>% 
  select(PROVIDER_NAME,numerator,denominator,pct) %>%
  arrange(as.character(PROVIDER_NAME)) %>%
  # Add subtotal line for PIHP
  rbind(
    ., 
    data.frame(
      PROVIDER_NAME = "Region 10", 
      t(colSums(.[2:3])),
      pct = round(colSums(.[2])/colSums(.[3])*100,digits = 1)
    )
  ) %>%
  select(PROVIDER_NAME,denominator,numerator,pct)

```

```{r family_table}
family_summary %>%
  datatable(
    rownames = FALSE,
    colnames = c('Organization','Total Enrollees Receiving Services','Without Family Services','% Non-Compliant'),
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(c(0,100), '#fc8d59'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )
```
<br>

The table below shows all open individuals who did not receive family training services during the most recent 90 days:

```{r family_detail}
family_svs %>%
  filter(has_fam == F) %>%
  select(Case_ID,PROVIDER_NAME) %>%
  datatable(
    rownames = FALSE,
    colnames = c('WSA ID','Organization'),
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis'),
      pageLength = 10,
      lengthMenu = c(10, 25, 50, nrow(family_svs))
    )
  )
```

---

# Non-ABA Services Received by Enrollees Without a Behavioral Plan of Service

```{r waitlist_create}
waitlist_svs <-
  wsa %>%
  # Filter individuals who are on waitlist
  filter(
    Status == "Open"
    & IPOSExists == F
    & is.na(Eligibility_Date) == F
  ) %>%
  select(ID,Case_ID,PIHP_CMH_Name,Referral_Date:Eligibility_End_Date) %>%
  left_join(svs, by = c("ID" = "MEDICAID_ID")) %>%
  filter(
    # Only include services occurring after eligibility for autism
    FROM_DATE > as.Date(Eligibility_Date)     
    # or if there is no service date (to keep people who didn't receive svs)
    | is.na(FROM_DATE) == T 
  ) 

waitlist_last90 <-
  waitlist_svs %>%
  # Only include services if they are in most recent 90 days of dataset
  filter(FROM_DATE >= last_90 & is.na(AUTISM_SRV)) %>%
  group_by(Case_ID,PIHP_CMH_Name,CPT_CD,SERVICE_DESC,UNIT_TYPE,AUTISM_SRV,Eligibility_Date) %>%
  # Convert units to a common period
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    svs_conv = recode(
      as.character(SERVICE_DESC),
      `Psychotherapy, 60 min` = 1, 
      `Psychotherapy, 45 min` = 0.75,
      `Psychotherapy, 30 min` = 0.5
    ),
    hr_conv = ifelse(is.na(svs_conv) == F,svs_conv,as.numeric(hr_conv)),
    # Calculate hours
    hrs = UNITS * hr_conv
  ) %>%
  # What is the first and last date of each service?
  mutate(
    first = min(FROM_DATE),
    last = max(FROM_DATE)
  ) %>%
  # What is the number of units received?
  summarize(
    encounters = n(),
    units = sum(UNITS, na.rm = T),
    hrs = sum(hrs, na.rm = T),
    first = min(FROM_DATE),
    last = max(FROM_DATE)
  ) 

waitlist_all <-
waitlist_svs %>%
  group_by(Case_ID,PIHP_CMH_Name,CPT_CD,SERVICE_DESC,UNIT_TYPE,AUTISM_SRV,Eligibility_Date) %>%
  # Convert units to a common period
  mutate(
    # Recode unit type as numeric conversion factor
    hr_conv = recode(
      as.character(UNIT_TYPE),
      `15 Minutes` = '0.25', 
      `30 Minutes` = '0.5',
      `Hour` = '1', 
      `Up to 15 min` = '0.25',
      `Encounter` = 'NA'
    ),
    svs_conv = recode(
      as.character(SERVICE_DESC),
      `Psychotherapy, 60 min` = 1, 
      `Psychotherapy, 45 min` = 0.75,
      `Psychotherapy, 30 min` = 0.5
    ),
    hr_conv = ifelse(is.na(svs_conv) == F,svs_conv,as.numeric(hr_conv)),
    # Calculate hours
    hrs = UNITS * hr_conv
  ) %>%
  # What is the first and last date of each service?
  mutate(
    first = min(FROM_DATE),
    last = max(FROM_DATE)
  ) %>%
  # What is the number of units received?
  summarize(
    encounters = n(),
    units = sum(UNITS, na.rm = T),
    hrs = sum(hrs, na.rm = T),
    first = min(FROM_DATE),
    last = max(FROM_DATE)
  ) 

waitlist_summary <-
  waitlist_last90 %>%
  group_by(Case_ID,PIHP_CMH_Name) %>%
  summarize(encounters = sum(encounters)) %>%
  mutate(
    has_enc = encounters >= 1
  ) %>%
  group_by(PIHP_CMH_Name) %>%
  summarize(
    has_enc = sum(has_enc, na.rm = T),
    denominator = n()
  ) %>%
  mutate(
    numerator = denominator - has_enc,
    pct = round(numerator / denominator * 100, digits = 1)
  ) %>% 
  select(PIHP_CMH_Name,numerator,denominator,pct) %>%
  arrange(as.character(PIHP_CMH_Name)) %>%
  # Add subtotal line for PIHP
  rbind(
    ., 
    data.frame(
      PIHP_CMH_Name = "Region 10", 
      t(colSums(.[2:3])),
      pct = round(colSums(.[2])/colSums(.[3])*100,digits = 1)
    )
  ) %>%
  select(PIHP_CMH_Name,denominator,numerator,pct)

waitlist_person <-
  waitlist_all %>%
  group_by(Case_ID,PIHP_CMH_Name) %>%
  summarize(
    first = min(first),
    last = max(last),
    Eligibility_Date = as.Date(max(Eligibility_Date)),
    svs_list = paste(SERVICE_DESC, collapse = ', '),
    encounters = sum(encounters),
    autism_waiver_svs = sum(AUTISM_SRV, na.rm = T)
  ) %>%
  mutate(
    # Most recent date in services data pulled
    max_date = max(svs$FROM_DATE, na.rm = T),
    elig_interval = as.numeric(max_date - (Eligibility_Date + 90)),
    svs_interval = as.numeric(last - first),
    pct_days_svd = round(svs_interval/elig_interval * 100, digits = 1),
    autism_waiver_svs = autism_waiver_svs > 0
  )

```

For enrollees who do not have a BPOS, what percent have not received at least one non-ABA service within the previous 90 days?

```{r waitlist_table}
waitlist_summary %>%
  datatable(
    rownames = FALSE,
    colnames = c('Organization','Total Enrollees without a BPOS','Enrollees Without Any Services','% Without Services'),
    extensions = c('Responsive','Buttons'),
    options = list(
      dom = 't',
      buttons = c('colvis')
    )
  ) %>%
  formatStyle(
    'pct',
    background = styleColorBar(c(0,100), '#fc8d59'),
    backgroundSize = '100% 90%',
    backgroundRepeat = 'no-repeat',
    backgroundPosition = 'center'
  )
```
<br>
```{r}
t1 <- waitlist_person %>%
  select(Case_ID,PIHP_CMH_Name,svs_list,elig_interval,pct_days_svd,encounters,autism_waiver_svs) %>%
  ungroup() %>%
  arrange(pct_days_svd)

t2 <- wsa %>%
  # Filter individuals who are on waitlist
  filter(
    Status == "Open"
    & IPOSExists == F
    & is.na(Eligibility_Date) == F
  ) %>%
  select(ID,Case_ID,PIHP_CMH_Name,Referral_Date:Eligibility_End_Date) %>%
  left_join(svs, by = c("ID" = "MEDICAID_ID")) %>%
  filter(
    # Only include services occurring after eligibility for autism
    FROM_DATE >= as.Date(Eligibility_Date) 
    # or if there is no service date (to keep people who didn't receive svs)
    | is.na(FROM_DATE) == T 
  ) %>%
  mutate(
    week = floor_date(FROM_DATE, unit = "week"),
    month = floor_date(FROM_DATE, unit = "month")
  ) %>%
  group_by(Case_ID,month) %>%
  summarize(Encounters = n()) %>%
  ungroup() %>%
  group_by(Case_ID) %>%
  summarise(Encounters = paste(Encounters, collapse = ","))

r <- range(t2$Encounters) # define min/max # of encounters for sparkline

t3 <- merge(x = t2, y = t1, by = "Case_ID", all.x = TRUE) # join t1 ad t2
```

```{r def_spark}
# Define attributes of line spark
line_string <- "type: 'line', lineColor: 'black', fillColor: '#ccc', highlightLineColor: 'orange', highlightSpotColor: 'orange'"

cd <- list(list(targets = 1, render = JS("function(data, type, full){ return '<span class=sparkSeries>' + data + '</span>' }")))

cb <- 
  JS(
    paste0(
      "function (oSettings, json) {\n $('.sparkSeries:not(:has(canvas))').sparkline('html', { ",
      line_string, " });\n}"
    ), 
    collapse = ""
  )
```

The table below includes the following information:

- *Encounters per month*: A trendline of the number of encounters the individual received per month during the time they have been without a BPOS.
- *Services provided*: A list of all non-ABA services which appear in the encounter data for the enrollee from the time that s/he was enrolled in the Autism Benefit.
- *Days without BPOS*: The number of days that the individual has been without a BPOS.
- *Total Encounters*: The total number of encounters, for any type of service, that the individual received while without a BPOS.

```{r waitlist_detail}

dt <- t3 %>%
  filter(autism_waiver_svs == F) %>%
  filter(elig_interval >= 0) %>%
  select(-autism_waiver_svs, -pct_days_svd) %>%
  datatable(
    data.table(),
    caption = "Non-ABA Services provided to Enrollees Without a Behavioral Plan of Service",
    rownames = FALSE,
    colnames = c('WSA ID','Encounters per month',
                 'Organization','Services provided',
                 'Days without BPOS','Total Encounters'),
    extensions = c('Responsive','Buttons'),
    options = list(
      columnDefs = cd,
      pageLength = 5,
      lengthMenu = c(5, 15, 25, 50, nrow(t3)),
      fnDrawCallback = cb,
      # dom = 't',
      buttons = c('colvis'))
    )

dt$dependencies <- append(dt$dependencies, htmlwidgets:::getDependency("sparkline"))

dt

```

---

# ABA Services for Enrollees Without a Behavioral Plan of Service

Some individuals are shown as not having a BPOS in the WSA system, but their service data shows that they have received ABA services.  This may indicate the need to update the individuals' status in the WSA system.  Note that addressing these changes in the WSA system will improve performance on the *Enrollees without a Behavioral Plan of Service* measure above.

These individuals are shown in the table below:

```{r}
dt <- t3 %>%
  filter(autism_waiver_svs == T) %>%
  filter(elig_interval >= 0) %>%
  select(-autism_waiver_svs, -pct_days_svd) %>%
  datatable(
    data.table(),
    caption = "ABA-inclusive Services provided to Enrollees Without a Behavioral Plan of Service",
    rownames = FALSE,
    colnames = c('WSA ID','Encounters per month',
                 'Organization','Services provided',
                 'Days on waitlist','Total Encounters'),
    extensions = c('Responsive','Buttons'),
    options = list(
      columnDefs = cd,
      pageLength = 5,
      lengthMenu = c(5, 15, 25, nrow(t3)),
      fnDrawCallback = cb,
      buttons = c('colvis'))
    )

dt$dependencies <- append(dt$dependencies, htmlwidgets:::getDependency("sparkline"))

dt
```

---

# Glossary

**ABA Services:** Services provided by the CMHSP, or contracted ABA provider, which include the S5108, H2019, 0364T, 0365T, 0366T, 0367T, 0372T, 0373T, 0374T, 0368T, and 0369T service codes reported with a U5 modifier. (Note: U5 modifier must be reported on all encounters covered by the EPSDT Autism Benefit).

**Behavioral Plan of Service (BPOS):** In WSA, this includes the ABA behavioral plan and the related Individual Plan of Service created by the CMHSP. 

**Days Without a Behavioral Plan of Service: **  The number of days without a Behavioral Plan of Service following eligibility determination date.  

**Eligibility Determination Date:** The date that MDHHS determines that an individual is eligible for ABA services.  

**Enrollee:** A person found eligible for the Autism Benefit, as determined by MDHHS. 

**Family Training:**  Required service provided by qualified practitioner. At least 1 encounter / 90 days meets the standard.  The service codes for Family Training are 0370T and 0371T.

**Hours of Service: ** ABA services including supervision/observation. 

**Hours of Treatment:** ABA services excluding supervision/observation.

**Number of Encounters:** The total count of service encounters received. Note: if multiple units are received as part of a single encounter, the encounter will only be counted once.    

**Observation of ABA Services:** The standard is for every 10 hours of ABA treatment provided to an individual enrollee, 1 hour of supervision/observation by a qualified practitioner will be provided. The service codes for observation are S5108, 0368T, and 0369T with a U5 modifier.

**Overdue Plans of Service: ** Cases with an expired plan of service in WSA.

**Overdue Re-Evaluation:** Cases with an expired re-evaluation (364 days from most recent evaluation end date) in WSA.

**Overdue Service Start:** Individuals determined eligible for ABA services awaiting the development of an ABA treatment plan to begin services.

**Prescribed Hours:** The number of hours an enrollee is authorized for ABA services based on assessed need and recommendation. This number is entered in WSA by the CMHSPs.

**Range of Intensity:** The hours of ABA treatment provided; within 25% +/- of prescribed hours meets the standard.

**Ratio of Observation to Treatment:** The result of dividing the number of hours of 'observation of ABA Services' by 'hours of treatment'. A ratio value of greater than or equal to 0.1 (1 hour of observation for every 10 hours of treatment) meets the standard.  Note that this metric only includes enrollees with a BPOS who received >= 10 hours of treatment during the reporting period.

**Services Provided:** A list of services (i.e. the descriptions which accompany HCPCS codes) that the enrollee has received. 

**Waiver Support Application (WSA):** The electronic platform used by MDHHS, PIHPs, and CMHs to monitor the Autism Benefit and enrollees. 
